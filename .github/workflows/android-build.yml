name: Android Build (with explicit sdkmanager)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      JAVA_TOOL_OPTIONS: -Dfile.encoding=UTF8

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Use JDK 17 so sdkmanager can run
      - name: Set up JDK 17 for sdkmanager
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Ensure Android SDK root exists
        run: |
          sudo mkdir -p /usr/local/lib/android/sdk || true
          export ANDROID_SDK_ROOT=/usr/local/lib/android/sdk
          echo "ANDROID_SDK_ROOT=$ANDROID_SDK_ROOT"

      - name: Install Android SDK packages with sdkmanager
        # each package passed as a separate argument to avoid the multiline-packages parsing issue
        run: |
          export ANDROID_SDK_ROOT=/usr/local/lib/android/sdk
          SDKMANAGER=/usr/local/lib/android/sdk/cmdline-tools/latest/bin/sdkmanager
          if [ ! -x "$SDKMANAGER" ]; then
            echo "cmdline-tools not found at $SDKMANAGER â€” attempting to use system sdkmanager"
            SDKMANAGER=$(command -v sdkmanager || true)
          fi
          if [ -z "$SDKMANAGER" ]; then
            echo "sdkmanager not found; aborting."
            exit 1
          fi
          echo "sdkmanager: $SDKMANAGER"
          # Accept licenses and install packages; use yes to accept prompts
          yes | "$SDKMANAGER" "cmdline-tools;latest" "platform-tools" "platforms;android-33" "build-tools;33.0.2"

      # Switch back to JDK 11 for Gradle if needed
      - name: Set up JDK 11 for Gradle build
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '11'

      - name: Cache Gradle
        uses: actions/cache@v3
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Ensure gradlew is executable
        run: chmod +x ./gradlew

      - name: Build Debug APK
        run: ./gradlew assembleDebug --no-daemon --stacktrace

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-apks
          path: app/build/outputs/**/*.apk
