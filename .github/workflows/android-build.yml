name: Android Build - Debug APK

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    name: Build Debug APK
    runs-on: ubuntu-latest
    env:
      JAVA_TOOL_OPTIONS: -Dfile.encoding=UTF8

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # If your Android project is in the 'android' folder (Capacitor), set PROJECT_DIR=android
      - name: Set project dir
        run: echo "PROJECT_DIR=${{ github.event.inputs.project_dir || 'android' }}" >> $GITHUB_ENV

      - name: Detect project directory
        run: |
          if [ -d "./android" ]; then
            echo "Found ./android - building there"
            echo "BUILD_DIR=android" >> $GITHUB_ENV
          elif [ -f "./gradlew" ]; then
            echo "Found gradlew at repo root - building at root"
            echo "BUILD_DIR=." >> $GITHUB_ENV
          else
            echo "No ./android folder and no gradlew at repo root. CI cannot build until Android project is added."
            ls -la
            exit 1
          fi

      - name: Ensure gradlew exists (generate wrapper ONLY as fallback)
        run: |
          cd "$BUILD_DIR"
          if [ -f ./gradlew ]; then
            echo "gradlew present"
            chmod +x ./gradlew
          else
            echo "gradlew not found in $BUILD_DIR â€” attempting to generate wrapper using local Gradle"
            GRADLE_VERSION=7.6.1
            DIST_URL="https://services.gradle.org/distributions/gradle-${GRADLE_VERSION}-bin.zip"
            mkdir -p /tmp/gradle-dist
            curl -fsSLo /tmp/gradle-dist/gradle.zip "$DIST_URL"
            unzip -q /tmp/gradle-dist/gradle.zip -d /tmp/gradle-dist
            export PATH="/tmp/gradle-dist/gradle-${GRADLE_VERSION}/bin:$PATH"
            gradle -v || true
            gradle wrapper --gradle-version ${GRADLE_VERSION} --no-daemon || { echo "Failed to create gradle wrapper"; ls -la; exit 1; }
            chmod +x ./gradlew
          fi

      - name: Set up JDK 17
        # Use JDK 17 to be compatible with modern sdkmanager and Android cmdline tools / AGP
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: (Optional) Install SDK packages only if needed
        # Usually ubuntu-latest already contains required platforms/build-tools; uncomment if you need to force-install.
        # run: yes | /usr/local/lib/android/sdk/cmdline-tools/latest/bin/sdkmanager "platform-tools" "platforms;android-33" "build-tools;33.0.2"
        run: echo "Skipping explicit sdkmanager install (use if build fails with missing SDK platform/build-tools)."

      - name: Build Debug APK
        working-directory: ${{ env.BUILD_DIR }}
        run: ./gradlew assembleDebug --no-daemon --stacktrace

      - name: List produced APKs
        run: |
          set -e
          if [ -d "${{ env.BUILD_DIR }}/app/build/outputs" ]; then
            find "${{ env.BUILD_DIR }}/app/build/outputs" -type f -name "*.apk" -print || true
          else
            echo "No app/build/outputs found in $BUILD_DIR"
            ls -la "${{ env.BUILD_DIR }}"
          fi

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-apks
          path: ${{ env.BUILD_DIR }}/app/build/outputs/**/*.apk
